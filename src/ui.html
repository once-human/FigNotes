<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>FigNotes Hardened</title>
    <style>
        :root {
            --bg: #FAFAF9;
            --surface: #FFFFFF;
            --accent: #8DA399;
            --accent-soft: #E2E8E4;
            --text-primary: #444442;
            --text-secondary: #71716F;
            --border: #EBEBE9;
            --radius: 12px;
            --transition: all 0.2s ease;
            --danger: #E76F51;
            --success: #A3B18A;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            margin: 0;
            user-select: none;
            overflow-x: hidden;
        }

        /* Skeleton Shimmer */
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .skeleton {
            background: linear-gradient(90deg, var(--border) 25%, var(--accent-soft) 50%, var(--border) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        .header {
            padding: 16px 20px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .btn-sync {
            background: var(--accent);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 11px;
        }

        .btn-sync:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .filter-bar {
            padding: 12px 20px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            border-bottom: 1px solid var(--border);
        }

        .chip {
            padding: 4px 10px;
            border-radius: 14px;
            border: 1px solid var(--border);
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            background: var(--surface);
            color: var(--text-secondary);
            transition: var(--transition);
        }

        .chip.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .content {
            padding: 16px 20px;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
        }

        .card-header {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .task-item {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
        }

        .error-state {
            padding: 40px;
            text-align: center;
            color: var(--danger);
        }

        .loading-skeleton {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
    </style>
</head>

<body>
    <div class="header">
        <div style="font-weight: 700; font-size: 16px;">FigNotes</div>
        <button id="syncBtn" class="btn-sync">Sync</button>
    </div>

    <div class="filter-bar">
        <div class="chip active" onclick="setFilter('all')">All</div>
        <div class="chip" onclick="setFilter('unresolved')">Unresolved</div>
        <div class="chip" onclick="setFilter('discussion')">Discussion</div>
    </div>

    <div id="main" class="content">
        <!-- Skeleton initially -->
        <div class="loading-skeleton">
            <div class="skeleton" style="height: 60px; border-radius: 12px;"></div>
            <div class="skeleton" style="height: 60px; border-radius: 12px;"></div>
            <div class="skeleton" style="height: 200px; border-radius: 12px;"></div>
        </div>
    </div>

    <script>
        const syncBtn = document.getElementById('syncBtn');
        const main = document.getElementById('main');
        let currentFilter = 'all';
        let latestData = null;

        syncBtn.onclick = () => {
            syncBtn.disabled = true;
            syncBtn.innerText = 'Updating...';
            parent.postMessage({ pluginMessage: { type: 'sync' } }, '*');
        };

        window.onmessage = (event) => {
            const { type, payload } = event.data.pluginMessage;

            if (type === 'sync-complete') {
                latestData = payload;
                render();
                syncBtn.disabled = false;
                syncBtn.innerText = 'Sync';
            } else if (type === 'sync-error') {
                renderError(payload);
                syncBtn.disabled = false;
                syncBtn.innerText = 'Sync';
            }
        };

        function setFilter(f) {
            currentFilter = f;
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            render();
        }

        function render() {
            if (latestData && latestData.isUnsupported) {
                main.innerHTML = `
                    <div style="padding: 24px; text-align: center; background: #FFF1F1; border: 1px solid #FFE4E4; border-radius: 12px; margin-bottom: 20px;">
                        <div style="font-weight: 700; color: #E76F51; margin-bottom: 8px; font-size: 14px;">Environment Limitation</div>
                        <p style="font-size: 12px; line-height: 1.5; color: #666; margin: 0 0 16px 0;">
                            Your current Figma app version is too old to support <b>Comment Extraction</b>. 
                        </p>
                        <div style="text-align: left; background: white; padding: 12px; border-radius: 8px; font-size: 11px;">
                            <b style="display: block; margin-bottom: 4px;">To fix this:</b>
                            1. Open this file in <b>Google Chrome</b> or Firefox.<br>
                            2. Right-click > Plugins > Development > FigNotes.<br>
                            3. Sync will work perfectly there!
                        </div>
                    </div>
                `;
                return;
            }

            if (!latestData || !latestData.metrics.length) {
                main.innerHTML = '<div style="text-align:center; padding: 40px; color: #999;">No comments found in this file.</div>';
                return;
            }

            let html = '';
            latestData.metrics.forEach(flow => {
                const tasks = latestData.tasks.filter(t => t.page === flow.flowName && matchesFilter(t));
                if (tasks.length === 0 && currentFilter !== 'all') return;

                html += `
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div style="font-weight: 600; font-size: 14px;">${flow.flowName}</div>
                                <div style="font-size: 10px; color: #999;">${flow.health} • ${Math.round(flow.weightedCompletion)}% Done</div>
                            </div>
                            <div style="font-size: 11px; font-weight: 700;">${flow.resolvedTasks}/${flow.totalTasks}</div>
                        </div>
                        <div class="tasks">
                            ${tasks.map(t => `
                                <div class="task-item">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500; font-size: 12px; ${t.resolved ? 'text-decoration: line-through; opacity: 0.5;' : ''}">${t.message}</div>
                                        <div style="font-size: 10px; color: #999; margin-top: 4px;">${t.frame} • ${t.ageInDays}d old</div>
                                    </div>
                                    <select style="font-size: 10px; border: 1px solid var(--border); border-radius: 4px;" onchange="updateTask('${t.commentId}', 'effort', parseInt(this.value))">
                                        <option value="1" ${t.effort == 1 ? 'selected' : ''}>S</option>
                                        <option value="2" ${t.effort == 2 ? 'selected' : ''}>M</option>
                                        <option value="3" ${t.effort == 3 ? 'selected' : ''}>L</option>
                                    </select>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            main.innerHTML = html || '<div style="text-align:center; padding: 40px; color: #999;">No tasks match this filter.</div>';
        }

        function matchesFilter(t) {
            if (currentFilter === 'all') return true;
            if (currentFilter === 'unresolved') return !t.resolved;
            if (currentFilter === 'discussion') return t.discussionStatus !== 'pending';
            return true;
        }

        function updateTask(id, key, value) {
            parent.postMessage({ pluginMessage: { type: 'update-task', payload: { id, key, value } } }, '*');
        }

        function renderError(err) {
            main.innerHTML = `<div class="error-state">
                <div style="font-weight: 700; margin-bottom: 8px;">Sync Failed</div>
                <div style="font-size: 11px; opacity: 0.8;">${err}</div>
            </div>`;
        }
    </script>
</body>

</html>