<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>FigNotes</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #FFFFFF;
            --text-main: #111111;
            --text-muted: #666666;
            --border: #F0F0F0;
            --radius-main: 8px;
            --radius-btn: 6px;
            --font-main: 'Inter', -apple-system, sans-serif;

            /* Blue Theme (Professional) */
            --blue-accent: #0070F6;
            --blue-accent-soft: #EBF5FF;
            --blue-accent-muted: #CCE3FD;
            --blue-shadow: 0 1px 4px rgba(0, 112, 246, 0.05);

            /* Pink Theme (Cute Thoughtful) */
            --pink-accent: #FC97CF;
            --pink-accent-soft: #FFF0F7;
            --pink-accent-muted: #FFD6EA;
            --pink-bg: #FFFAFC;
            --pink-shadow: 0 2px 8px rgba(252, 151, 207, 0.08);
        }

        body.theme-blue {
            --accent: var(--blue-accent);
            --accent-soft: var(--blue-accent-soft);
            --accent-muted: var(--blue-accent-muted);
            --shadow: var(--blue-shadow);
            --radius: var(--radius-main);
            --body-bg: var(--bg);
            --anim-tab: all 0.15s ease-in-out;
            --anim-bounce: none;
        }

        body.theme-pink {
            --accent: var(--pink-accent);
            --accent-soft: var(--pink-accent-soft);
            --accent-muted: var(--pink-accent-muted);
            --shadow: var(--pink-shadow);
            --radius: 12px;
            --body-bg: var(--pink-bg);
            --anim-tab: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            --anim-bounce: scale(1.02);
        }

        body {
            font-family: var(--font-main);
            background: var(--body-bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            letter-spacing: -0.01em;
            transition: background 0.3s ease;
        }

        /* --- Compact Header --- */
        .header {
            background: white;
            z-index: 1000;
            border-bottom: 1px solid var(--border);
            padding: 0;
        }

        .top-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
        }

        /* --- Inline Navigation --- */
        .nav-row {
            display: flex;
            align-items: center;
            padding: 0 14px;
            border-bottom: 1px solid var(--border);
            gap: 16px;
        }

        .tab {
            padding: 10px 0;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: var(--anim-tab);
            white-space: nowrap;
            opacity: 0.6;
            margin-bottom: -1px;
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
            opacity: 1;
        }

        .nav-divider {
            width: 1px;
            height: 14px;
            background: var(--border);
            margin: 0 4px;
        }

        /* --- Controls Bar --- */
        .controls-row {
            display: flex;
            align-items: center;
            padding: 6px 14px;
            gap: 8px;
            background: #FAFAFA;
            border-bottom: 1px solid var(--border);
        }

        .sub-tab-group {
            display: flex;
            background: #E0E0E0;
            padding: 2px;
            border-radius: 6px;
            gap: 1px;
        }

        .sub-tab {
            padding: 4px 10px;
            font-size: 10px;
            font-weight: 800;
            border-radius: 4px;
            cursor: pointer;
            background: transparent;
            color: var(--text-muted);
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .sub-tab.active {
            background: white;
            color: var(--text-main);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .btn-filter {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 700;
            border-radius: 6px;
            cursor: pointer;
            background: white;
            border: 1px solid var(--border);
            color: var(--text-muted);
        }

        .btn-filter.active {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-soft);
        }

        /* --- Progress Hairline --- */
        .progress-container {
            position: relative;
            height: 2px;
            background: #F0F0F0;
            width: 100%;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.6s cubic-bezier(0.1, 0.9, 0.2, 1);
        }

        .metrics-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 14px;
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
            background: white;
        }

        /* --- Filter Dropdown --- */
        .filter-dropdown {
            position: absolute;
            top: 100%;
            right: 14px;
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 8px;
            display: none;
            z-index: 2000;
            min-width: 120px;
        }

        .filter-dropdown.active {
            display: block;
        }

        .filter-option {
            padding: 8px 10px;
            font-size: 11px;
            font-weight: 700;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .filter-option:hover {
            background: #F5F5F5;
        }

        .filter-option.selected {
            color: var(--accent);
            background: var(--accent-soft);
        }

        /* --- Scrollable Content --- */
        .viewport {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 100px;
            background: transparent;
        }

        /* --- Task Cards --- */
        .task-card {
            margin: 8px 12px;
            padding: 12px;
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
            position: relative;
        }

        .task-card:hover {
            border-color: var(--accent-muted);
            box-shadow: var(--shadow);
            transform: var(--anim-bounce);
        }

        .task-card.resolved {
            opacity: 0.5;
            filter: grayscale(0.5);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .author {
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            color: var(--text-muted);
            letter-spacing: 0.02em;
        }

        .card-meta {
            font-size: 10px;
            color: #999;
            font-weight: 600;
        }

        .message {
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 12px;
            word-break: break-word;
            color: var(--text-main);
        }

        /* --- Effort Selector (Compact Horizontal) --- */
        .effort-bar {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
        }

        .effort-pill {
            flex: 1;
            padding: 6px 0;
            font-size: 10px;
            font-weight: 800;
            text-align: center;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: #FAFAFA;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.1s;
            text-transform: uppercase;
        }

        .effort-pill:hover {
            border-color: var(--accent);
        }

        .effort-pill.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .btn-work {
            flex: 1;
            padding: 8px;
            background: var(--accent-soft);
            color: var(--accent);
            border: none;
            border-radius: var(--radius-btn);
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
        }

        .btn-resolve {
            padding: 8px 12px;
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius-btn);
            color: var(--text-muted);
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
        }

        .btn-resolve:hover {
            color: #2E7D32;
            border-color: #A5D6A7;
        }

        /* --- Cat Overlay --- */
        .cat-box {
            position: fixed;
            bottom: 72px;
            left: 0;
            right: 0;
            height: 48px;
            pointer-events: none;
            z-index: 900;
        }

        .cat {
            position: absolute;
            bottom: 0;
            width: 40px;
            height: 40px;
            opacity: 0;
            transition: left 3s linear, opacity 0.5s;
        }

        body.theme-pink .cat {
            opacity: 1;
        }

        /* --- Footer --- */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 12px 14px;
            background: white;
            border-top: 1px solid var(--border);
            z-index: 1000;
        }

        .btn-sync {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius-main);
            font-size: 13px;
            font-weight: 800;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
        }

        /* --- Overlay --- */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 2000;
            padding: 24px;
            display: none;
        }

        .overlay.active {
            display: block;
        }
    </style>
</head>

<body class="theme-blue">

    <div class="header">
        <!-- Top Title Root -->
        <div class="top-row">
            <div style="font-size: 16px; font-weight: 900; letter-spacing: -0.04em;">FigNotes</div>
            <div style="display:flex; gap:10px; align-items:center;">
                <div class="icon-btn" id="catToggle" onclick="toggleTheme()" title="Toggle Theme">üê±</div>
                <div class="icon-btn" onclick="toggleSettings(true)" title="Settings">‚öôÔ∏è</div>
            </div>
        </div>

        <!-- Primary Navigation -->
        <div class="nav-row">
            <div class="tab active" data-id="all" onclick="setPrimaryTab('all')">All</div>
            <div class="tab" data-id="me" onclick="setPrimaryTab('me')">Assigned</div>
            <div class="tab" data-id="discussion" onclick="setPrimaryTab('discussion')">Discussion</div>
        </div>

        <!-- Secondary Sub-Navigation & Filters -->
        <div class="controls-row">
            <div class="sub-tab-group">
                <div class="sub-tab active" data-id="pending" onclick="setSecondaryTab('pending')">Pending</div>
                <div class="sub-tab" data-id="resolved" onclick="setSecondaryTab('resolved')">Resolved</div>
            </div>

            <div class="btn-filter" id="filterBtn" onclick="toggleFilterDropdown()">
                <view-icon>üîç</view-icon>
                <span id="filterLabel">Effort</span>
            </div>

            <!-- Filter Dropdown -->
            <div class="filter-dropdown" id="filterMenu">
                <div class="filter-option" id="optS" onclick="toggleEffortFilter('Small')">Small <span
                        class="check"></span></div>
                <div class="filter-option" id="optM" onclick="toggleEffortFilter('Medium')">Medium <span
                        class="check"></span></div>
                <div class="filter-option" id="optL" onclick="toggleEffortFilter('Large')">Large <span
                        class="check"></span></div>
            </div>
        </div>

        <!-- Metrics & Progress -->
        <div class="metrics-row">
            <span id="progressPercent">0% complete</span>
            <div style="display:flex; gap:8px;">
                <span id="totalCount">0 Total</span>
                <span style="opacity:0.5;">/</span>
                <span id="pendingCount">0 Pending</span>
            </div>
        </div>
        <div class="progress-container">
            <div class="progress-fill" id="progressBar"></div>
        </div>
    </div>

    <!-- Content -->
    <div class="viewport" id="content">
        <!-- Rendered dynamically -->
    </div>

    <!-- Cat Box -->
    <div class="cat-box" id="catBox"></div>

    <!-- Footer -->
    <div class="footer">
        <button class="btn-sync" onclick="triggerSync()">Sync Workboard</button>
    </div>

    <!-- Overlay Settings -->
    <div id="settingsView" class="overlay">
        <h2 style="font-weight: 900; margin-top:0;">Figma Setup</h2>
        <div style="margin-bottom:20px;">
            <label style="font-size:10px; font-weight:800; color:#666; text-transform:uppercase;">Access Token</label>
            <input type="password" id="patInput"
                style="width:100%; padding:12px; margin-top:4px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;">
        </div>
        <div style="margin-bottom:24px;">
            <label style="font-size:10px; font-weight:800; color:#666; text-transform:uppercase;">File URL</label>
            <input type="text" id="urlInput"
                style="width:100%; padding:12px; margin-top:4px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;">
        </div>
        <button class="btn-sync" onclick="saveSettings()">Save & Close</button>
        <p style="text-align:center; font-size:12px; color:#666; margin-top:20px; cursor:pointer;"
            onclick="toggleSettings(false)">Cancel</p>
    </div>

    <script>
        let latestData = null;
        let config = { pat: '', fileUrl: '' };
        let primTab = 'all';
        let secTab = 'pending';
        let effortFilters = new Set();
        let currentTheme = 'blue';

        // --- Communication ---
        window.onmessage = (event) => {
            const { type, payload } = event.data.pluginMessage;
            if (type === 'settings-loaded') {
                config = payload;
                document.getElementById('patInput').value = config.pat || '';
                document.getElementById('urlInput').value = config.fileUrl || '';
                if (config.pat && config.fileUrl) triggerSync();
                else toggleSettings(true);
            } else if (type === 'sync-complete') {
                latestData = payload;
                if (payload.theme) applyTheme(payload.theme);
                render();
            }
        };

        parent.postMessage({ pluginMessage: { type: 'init' } }, '*');

        // --- Navigation ---
        function setPrimaryTab(id) {
            primTab = id;
            document.querySelectorAll('.nav-row .tab').forEach(t => t.classList.toggle('active', t.dataset.id === id));
            render();
        }

        function setSecondaryTab(id) {
            secTab = id;
            document.querySelectorAll('.sub-tab-group .sub-tab').forEach(t => t.classList.toggle('active', t.dataset.id === id));
            render();
        }

        function toggleFilterDropdown() {
            document.getElementById('filterMenu').classList.toggle('active');
        }

        function toggleEffortFilter(id) {
            if (effortFilters.has(id)) effortFilters.delete(id);
            else effortFilters.add(id);

            document.getElementById('opt' + id[0]).classList.toggle('selected');
            document.getElementById('filterBtn').classList.toggle('active', effortFilters.size > 0);
            render();
        }

        // --- Theme ---
        function toggleTheme() {
            const next = currentTheme === 'blue' ? 'pink' : 'blue';
            applyTheme(next);
            parent.postMessage({ pluginMessage: { type: 'set-theme', payload: next } }, '*');
        }

        function applyTheme(theme) {
            currentTheme = theme;
            document.body.className = 'theme-' + theme;
            document.getElementById('catToggle').innerText = theme === 'pink' ? 'üê±' : 'üêà';

            if (theme === 'pink') initCats();
            else clearCats();
        }

        // --- Actions ---
        function triggerSync() {
            if (!config.pat || !config.fileUrl) return;
            const match = config.fileUrl.match(/figma\.com\/(?:file|design)\/([a-zA-Z0-9]+)/)?.[1];
            if (!match) return;

            document.getElementById('content').innerHTML = '<div style="padding:40px; text-align:center; font-size:11px; font-weight:800; opacity:0.5;">SYNCING DATA...</div>';

            fetch(`https://api.figma.com/v1/files/${match}/comments`, {
                headers: { 'X-Figma-Token': config.pat }
            })
                .then(r => r.json())
                .then(data => {
                    parent.postMessage({ pluginMessage: { type: 'sync', payload: data.comments } }, '*');
                })
                .catch(() => alert("Sync Failed"));
        }

        function handleResolve(id, isResolved) {
            const type = isResolved ? 'resolve-comment' : 'unresolve-comment';
            parent.postMessage({ pluginMessage: { type, payload: id } }, '*');
            const match = config.fileUrl.match(/figma\.com\/(?:file|design)\/([a-zA-Z0-9]+)/)?.[1];
            fetch(`https://api.figma.com/v1/files/${match}/comments/${id}`, {
                method: 'POST',
                headers: { 'X-Figma-Token': config.pat, 'Content-Type': 'application/json' },
                body: JSON.stringify({ resolved: isResolved })
            });
        }

        function updateEffort(id, curr, target) {
            const val = curr === target ? null : target;
            parent.postMessage({ pluginMessage: { type: 'update-task', payload: { id, key: 'effort', value: val } } }, '*');
        }

        function setWorking(id) {
            parent.postMessage({ pluginMessage: { type: 'set-working', payload: id } }, '*');
        }

        function locate(id, el) {
            el.classList.add('pulse');
            setTimeout(() => el.classList.remove('pulse'), 400);
            parent.postMessage({ pluginMessage: { type: 'locate-node', payload: id } }, '*');
        }

        function toggleSettings(show) { document.getElementById('settingsView').classList.toggle('active', show); }
        function saveSettings() {
            config.pat = document.getElementById('patInput').value;
            config.fileUrl = document.getElementById('urlInput').value;
            parent.postMessage({ pluginMessage: { type: 'save-settings', payload: config } }, '*');
            toggleSettings(false);
            triggerSync();
        }

        // --- Rendering ---
        function render() {
            if (!latestData) return;
            const { tasks, currentUser } = latestData;

            // Filtering
            let scoped = tasks.filter(t => {
                if (primTab === 'me') return t.assignee === currentUser;
                if (primTab === 'discussion') return t.mentions.includes(currentUser) && t.mentions.length > 1;
                return true;
            });

            // Metrics
            const total = scoped.length;
            const resolved = scoped.filter(t => t.resolved).length;
            const pending = total - resolved;
            const pct = total > 0 ? Math.round((resolved / total) * 100) : 0;

            document.getElementById('totalCount').innerText = `${total} Total`;
            document.getElementById('pendingCount').innerText = `${pending} Pending`;
            document.getElementById('progressPercent').innerText = `${pct}% Resolved`;
            document.getElementById('progressBar').style.width = pct + '%';

            let view = scoped.filter(t => (secTab === 'resolved' ? t.resolved : !t.resolved));
            if (effortFilters.size > 0) view = view.filter(t => effortFilters.has(t.effort));

            const working = tasks.find(t => t.isCurrentlyWorking);

            let html = '';
            // Pinned
            if (working && !working.resolved && secTab === 'pending') {
                html += `<div class="pinned-section" style="background:var(--accent-soft); border-bottom:1px solid var(--border); padding:10px 12px;">
                    <span style="font-size:9px; font-weight:800; color:var(--accent); text-transform:uppercase; margin-bottom:8px; display:block;">Current Goal</span>
                    ${renderCard(working)}
                </div>`;
            }

            const list = view.filter(t => !t.isCurrentlyWorking);
            if (list.length === 0) {
                html += `<div style="padding:60px 20px; text-align:center; font-size:12px; color:#999;">Board is clear.</div>`;
            } else {
                html += list.map(t => renderCard(t)).join('');
            }

            document.getElementById('content').innerHTML = html;
        }

        function renderCard(t) {
            return `
                <div class="task-card ${t.resolved ? 'resolved' : ''}" onclick="locate('${t.commentId}', this)">
                    <div class="task-header">
                        <span class="author">${t.author}</span>
                        <span class="card-meta">${t.page} / ${t.frame}</span>
                    </div>
                    <div class="message">${t.message}</div>
                    
                    ${!t.resolved ? `
                        <div class="effort-bar" onclick="event.stopPropagation()">
                            <div class="effort-pill ${t.effort === 'Small' ? 'active' : ''}" onclick="updateEffort('${t.commentId}', '${t.effort}', 'Small')">S</div>
                            <div class="effort-pill ${t.effort === 'Medium' ? 'active' : ''}" onclick="updateEffort('${t.commentId}', '${t.effort}', 'Medium')">M</div>
                            <div class="effort-pill ${t.effort === 'Large' ? 'active' : ''}" onclick="updateEffort('${t.commentId}', '${t.effort}', 'Large')">L</div>
                        </div>
                        <div class="card-actions" onclick="event.stopPropagation()">
                            <button class="btn-work" style="${t.isCurrentlyWorking ? 'background:var(--accent); color:white;' : ''}" onclick="setWorking(${t.isCurrentlyWorking ? 'null' : `'${t.commentId}'`})">
                                ${t.isCurrentlyWorking ? 'Focusing' : 'Focus'}
                            </button>
                            <button class="btn-resolve" onclick="handleResolve('${t.commentId}', true)">Resolve</button>
                        </div>
                    ` : `
                        <button class="btn-resolve" onclick="event.stopPropagation(); handleResolve('${t.commentId}', false)" style="width:100%;">Re-open</button>
                    `}
                </div>
            `;
        }

        // --- Cats ---
        let catIntervals = [];
        function initCats() {
            clearCats();
            const box = document.getElementById('catBox');
            box.innerHTML = `<div class="cat" id="c1">${getCatSVG('#FC97CF')}</div><div class="cat" id="c2">${getCatSVG('#FFD6EA')}</div>`;
            const cats = box.querySelectorAll('.cat');
            cats.forEach((c, i) => {
                c.style.left = (20 + i * 80) + 'px';
                catIntervals.push(setInterval(() => {
                    if (currentTheme !== 'pink') return;
                    c.style.left = Math.random() * (window.innerWidth - 40) + 'px';
                }, 10000 + i * 2000));
            });
        }
        function clearCats() {
            catIntervals.forEach(clearInterval);
            catIntervals = [];
            const cats = document.querySelectorAll('.cat');
            cats.forEach(c => { c.style.left = '-60px'; setTimeout(() => c.remove(), 2000); });
        }
        function getCatSVG(c) {
            return `<svg viewBox="0 0 48 48" fill="none"><path d="M12 36C12 36 12 28 24 28C36 28 36 36 36 36" stroke="${c}" stroke-width="2.5"/><circle cx="24" cy="22" r="7" fill="white" stroke="${c}" stroke-width="1.5"/><path d="M17 18L14 10L21 15" fill="${c}"/><path d="M31 18L34 10L27 15" fill="${c}"/></svg>`;
        }
    </script>
</body>

</html>