<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>FigNotes Modern</title>
    <style>
        :root {
            --bg: #FAFAF9;
            --surface: #FFFFFF;
            --accent: #8DA399;
            --accent-soft: #E2E8E4;
            --text-primary: #444442;
            --text-secondary: #71716F;
            --border: #EBEBE9;
            --radius: 12px;
            --transition: all 0.2s ease;
            --danger: #E76F51;
            --success: #A3B18A;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            margin: 0;
            user-select: none;
            overflow-x: hidden;
        }

        /* Skeleton Shimmer */
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .skeleton {
            background: linear-gradient(90deg, var(--border) 25%, var(--accent-soft) 50%, var(--border) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        .header {
            padding: 16px 20px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .btn-sync {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            transition: var(--transition);
        }

        .btn-sync:hover {
            filter: brightness(0.9);
        }

        .btn-sync:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .filter-bar {
            padding: 12px 20px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            border-bottom: 1px solid var(--border);
        }

        .chip {
            padding: 6px 14px;
            border-radius: 20px;
            border: 1px solid var(--border);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            background: var(--surface);
            color: var(--text-secondary);
            transition: var(--transition);
            white-space: nowrap;
        }

        .chip.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .content {
            padding: 16px 20px;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.05);
        }

        .card-header {
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .task-item {
            padding: 14px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .error-state {
            padding: 60px 40px;
            text-align: center;
        }

        .loading-skeleton {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        select {
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid var(--border);
            font-size: 11px;
            color: var(--text-secondary);
            outline: none;
            background: var(--bg);
        }
    </style>
</head>

<body>
    <div class="header">
        <div style="font-weight: 700; font-size: 18px; letter-spacing: -0.5px;">FigNotes</div>
        <button id="syncBtn" class="btn-sync">Sync</button>
    </div>

    <div class="filter-bar">
        <div class="chip active" onclick="setFilter('all')">All</div>
        <div class="chip" onclick="setFilter('unresolved')">Unresolved</div>
        <div class="chip" onclick="setFilter('discussion')">Discussion</div>
    </div>

    <div id="main" class="content">
        <div class="loading-skeleton">
            <div class="skeleton" style="height: 80px; border-radius: 12px;"></div>
            <div class="skeleton" style="height: 80px; border-radius: 12px;"></div>
            <div class="skeleton" style="height: 200px; border-radius: 12px;"></div>
        </div>
    </div>

    <script>
        const syncBtn = document.getElementById('syncBtn');
        const main = document.getElementById('main');
        let currentFilter = 'all';
        let latestData = null;

        syncBtn.onclick = () => {
            syncBtn.disabled = true;
            syncBtn.innerText = 'Syncing...';
            parent.postMessage({ pluginMessage: { type: 'sync' } }, '*');
        };

        window.onmessage = (event) => {
            const { type, payload } = event.data.pluginMessage;
            if (type === 'sync-complete') {
                latestData = payload;
                render();
                syncBtn.disabled = false;
                syncBtn.innerText = 'Sync';
            } else if (type === 'sync-error') {
                renderError(payload);
                syncBtn.disabled = false;
                syncBtn.innerText = 'Sync';
            }
        };

        function setFilter(f) {
            currentFilter = f;
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            if (event) event.target.classList.add('active');
            render();
        }

        function render() {
            if (!latestData || !latestData.metrics || latestData.metrics.length === 0) {
                main.innerHTML = `
                    <div style="text-align:center; padding: 80px 40px; color: var(--text-secondary);">
                        <div style="font-size: 32px; margin-bottom: 16px;">üí¨</div>
                        <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">No comments found</div>
                        <div style="font-size: 13px; opacity: 0.7;">Add some comments to your design and click Sync.</div>
                    </div>
                `;
                return;
            }

            let html = '';
            latestData.metrics.forEach(flow => {
                const tasks = latestData.tasks.filter(t => t.page === flow.flowName && matchesFilter(t));
                if (tasks.length === 0 && currentFilter !== 'all') return;

                html += `
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div style="font-weight: 600; font-size: 15px;">${flow.flowName}</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">
                                    ${flow.health} ‚Ä¢ ${Math.round(flow.weightedCompletion)}% Complete
                                </div>
                            </div>
                            <div style="font-size: 12px; font-weight: 700; background: var(--accent-soft); padding: 4px 8px; border-radius: 6px; color: var(--accent);">
                                ${flow.resolvedTasks}/${flow.totalTasks}
                            </div>
                        </div>
                        <div class="tasks">
                            ${tasks.map(t => `
                                <div class="task-item">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500; font-size: 13px; line-height: 1.4; ${t.resolved ? 'text-decoration: line-through; opacity: 0.5;' : ''}">${t.message}</div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 6px; display: flex; gap: 8px;">
                                            <span>üè† ${t.frame}</span>
                                            <span>‚è≥ ${t.ageInDays}d old</span>
                                        </div>
                                    </div>
                                    <select onchange="updateTask('${t.commentId}', 'effort', parseInt(this.value))">
                                        <option value="1" ${t.effort == 1 ? 'selected' : ''}>S</option>
                                        <option value="2" ${t.effort == 2 ? 'selected' : ''}>M</option>
                                        <option value="3" ${t.effort == 3 ? 'selected' : ''}>L</option>
                                    </select>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            main.innerHTML = html;
        }

        function matchesFilter(t) {
            if (currentFilter === 'all') return true;
            if (currentFilter === 'unresolved') return !t.resolved;
            if (currentFilter === 'discussion') return t.discussionStatus !== 'pending';
            return true;
        }

        function updateTask(id, key, value) {
            parent.postMessage({ pluginMessage: { type: 'update-task', payload: { id, key, value } } }, '*');
        }

        function renderError(err) {
            main.innerHTML = `
                <div class="error-state">
                    <div style="font-size: 32px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                    <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px; color: var(--danger);">Sync Error</div>
                    <div style="font-size: 13px; opacity: 0.7;">${err}</div>
                </div>
            `;
        }
    </script>
</body>

</html>