<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>FigNotes Modern</title>
    <style>
        :root {
            --bg: #FAFAF9;
            --surface: #FFFFFF;
            --accent: #8DA399;
            --accent-soft: #E2E8E4;
            --text-primary: #444442;
            --text-secondary: #71716F;
            --border: #EBEBE9;
            --radius: 12px;
            --transition: all 0.2s ease;
            --danger: #E76F51;
            --success: #A3B18A;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            margin: 0;
            user-select: none;
            overflow-x: hidden;
        }

        .header {
            padding: 16px 20px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .btn-sync {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            transition: var(--transition);
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            opacity: 0.6;
            transition: var(--transition);
        }

        .btn-icon:hover {
            opacity: 1;
        }

        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }

        .content {
            padding: 16px 20px;
        }

        /* Settings Styles */
        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .input-group input {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            outline: none;
            transition: var(--transition);
        }

        .input-group input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }

        .help-text {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: -4px;
        }

        /* Sync Styles */
        .filter-bar {
            padding: 12px 20px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            border-bottom: 1px solid var(--border);
        }

        .chip {
            padding: 6px 14px;
            border-radius: 20px;
            border: 1px solid var(--border);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            background: var(--surface);
            color: var(--text-secondary);
            transition: var(--transition);
        }

        .chip.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
        }

        .card-header {
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-item {
            padding: 14px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        select {
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid var(--border);
            font-size: 11px;
            color: var(--text-secondary);
            outline: none;
            background: var(--bg);
        }
    </style>
</head>

<body>
    <div class="header">
        <div
            style="font-weight: 700; font-size: 18px; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px;">
            FigNotes
            <button class="btn-icon" id="settingsToggleBtn" title="Settings">‚öôÔ∏è</button>
        </div>
        <button id="syncBtn" class="btn-sync">Sync</button>
    </div>

    <!-- SETTINGS VIEW -->
    <div id="settingsView" class="view-section content active">
        <div style="margin-bottom: 24px;">
            <h2 style="margin: 0 0 8px 0; font-size: 16px;">Configuration</h2>
            <p style="margin: 0; font-size: 13px; color: var(--text-secondary); line-height: 1.4;">
                Figma requires a Personal Access Token (PAT) and the File URL to securely extract comments.
            </p>
        </div>

        <div class="settings-form">
            <div class="input-group">
                <label for="patInput">Personal Access Token</label>
                <input type="password" id="patInput" placeholder="figd_...">
                <div class="help-text">Generate this in Figma Account Settings > Personal access tokens.</div>
            </div>

            <div class="input-group">
                <label for="urlInput">Figma File URL</label>
                <input type="text" id="urlInput" placeholder="https://www.figma.com/file/...">
                <div class="help-text">Paste the full URL of this exact file.</div>
            </div>

            <button class="btn-sync" id="saveSettingsBtn" style="margin-top: 8px;">Save Configuration</button>
        </div>
    </div>

    <!-- MAIN SYNC VIEW -->
    <div id="mainView" class="view-section">
        <div class="filter-bar">
            <div class="chip active" onclick="setFilter('all')">All</div>
            <div class="chip" onclick="setFilter('unresolved')">Unresolved</div>
            <div class="chip" onclick="setFilter('discussion')">Discussion</div>
        </div>

        <div id="mainContent" class="content">
            <!-- Rendered by JS -->
        </div>
    </div>

    <script>
        const syncBtn = document.getElementById('syncBtn');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const settingsToggleBtn = document.getElementById('settingsToggleBtn');
        const settingsView = document.getElementById('settingsView');
        const mainView = document.getElementById('mainView');

        const patInput = document.getElementById('patInput');
        const urlInput = document.getElementById('urlInput');
        const mainContent = document.getElementById('mainContent');

        let currentFilter = 'all';
        let latestData = null;
        let config = { pat: '', fileUrl: '' };
        let nativeFileKey = null;

        // --- Navigation ---
        let isSettingsOpen = true; // Defaults open until settings load

        function toggleSettings(forceState) {
            isSettingsOpen = forceState !== undefined ? forceState : !isSettingsOpen;
            if (isSettingsOpen) {
                settingsView.classList.add('active');
                mainView.classList.remove('active');
            } else {
                settingsView.classList.remove('active');
                mainView.classList.add('active');
            }
        }

        settingsToggleBtn.onclick = () => toggleSettings();

        // --- Messages from Code.ts ---
        window.onmessage = (event) => {
            const { type, payload } = event.data.pluginMessage;

            if (type === 'init') {
                if (payload && payload.fileKey) {
                    nativeFileKey = payload.fileKey;
                    document.getElementById('urlInput').placeholder = "Auto-detected by Figma! Leave blank.";
                }
                // Request settings on boot
                parent.postMessage({ pluginMessage: { type: 'get-settings' } }, '*');
            }
            else if (type === 'settings-loaded') {
                config = payload;
                patInput.value = config.pat || '';
                urlInput.value = config.fileUrl || '';

                if (config.pat && (config.fileUrl || nativeFileKey)) {
                    toggleSettings(false);
                    triggerSync();
                } else {
                    toggleSettings(true);
                }
            }
            else if (type === 'sync-complete') {
                latestData = payload;
                renderTasks();
                setSyncingState(false);
            }
            else if (type === 'sync-error') {
                renderError(payload || "Unknown error occurred.");
                setSyncingState(false);
            }
        };

        // --- Settings Management ---
        saveSettingsBtn.onclick = () => {
            config.pat = patInput.value.trim();
            config.fileUrl = urlInput.value.trim();

            if (!config.pat || (!config.fileUrl && !nativeFileKey)) {
                alert("Both Token and URL are required (unless URL was auto-detected).");
                return;
            }

            parent.postMessage({
                pluginMessage: { type: 'save-settings', payload: config }
            }, '*');

            toggleSettings(false);
            triggerSync();
        };

        // --- Core Sync Logic (REST API + Canvas Merge) ---
        function setSyncingState(isSyncing) {
            syncBtn.disabled = isSyncing;
            syncBtn.innerText = isSyncing ? 'Syncing...' : 'Sync';
        }

        syncBtn.onclick = triggerSync;

        async function triggerSync() {
            if (!config.pat || (!config.fileUrl && !nativeFileKey)) {
                toggleSettings(true);
                return;
            }

            setSyncingState(true);
            mainContent.innerHTML = `<div style="text-align:center; padding: 40px; color: var(--text-secondary);">Fetching comments from Figma API...</div>`;

            let fileKey = nativeFileKey;
            if (!fileKey) {
                // Extract File Key from URL (e.g. https://www.figma.com/file/abc123def/...)
                const match = config.fileUrl.match(/figma\.com\/(?:file|design)\/([a-zA-Z0-9]+)/);
                if (!match) {
                    renderError("Invalid Figma URL format. Could not extract File Key.");
                    setSyncingState(false);
                    return;
                }
                fileKey = match[1];
            }

            try {
                // 1. Fetch Comments via REST API
                const response = await fetch(`https://api.figma.com/v1/files/${fileKey}/comments`, {
                    headers: {
                        'X-Figma-Token': config.pat
                    }
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();

                // 2. Send Raw REST Comments to canvas to resolve nodes/frames and merge with Storage
                parent.postMessage({
                    pluginMessage: { type: 'sync', payload: data.comments }
                }, '*');

            } catch (err) {
                console.error("REST API Error:", err);
                renderError("Failed to fetch comments. Check your Token and URL. Detail: " + err.message);
                setSyncingState(false);
            }
        }

        // --- View Logic ---
        function setFilter(f) {
            currentFilter = f;
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            if (event) event.target.classList.add('active');
            renderTasks();
        }

        function renderTasks() {
            if (!latestData || !latestData.metrics || latestData.metrics.length === 0) {
                mainContent.innerHTML = `
                    <div style="text-align:center; padding: 80px 40px; color: var(--text-secondary);">
                        <div style="font-size: 32px; margin-bottom: 16px;">üí¨</div>
                        <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">No comments found</div>
                        <div style="font-size: 13px; opacity: 0.7;">Ensure the URL points to this exact file.</div>
                    </div>
                `;
                return;
            }

            let html = '';
            latestData.metrics.forEach(flow => {
                const tasks = latestData.tasks.filter(t => t.page === flow.flowName && matchesFilter(t));
                if (tasks.length === 0 && currentFilter !== 'all') return;

                html += `
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div style="font-weight: 600; font-size: 15px;">${flow.flowName}</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">
                                    ${flow.health} ‚Ä¢ ${Math.round(flow.weightedCompletion)}% Complete
                                </div>
                            </div>
                            <div style="font-size: 12px; font-weight: 700; background: var(--accent-soft); padding: 4px 8px; border-radius: 6px; color: var(--accent);">
                                ${flow.resolvedTasks}/${flow.totalTasks}
                            </div>
                        </div>
                        <div class="tasks">
                            ${tasks.map(t => `
                                <div class="task-item">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500; font-size: 13px; line-height: 1.4; ${t.resolved ? 'text-decoration: line-through; opacity: 0.5;' : ''}">${t.message}</div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 6px; display: flex; gap: 8px; align-items: center;">
                                            <span>üè† ${t.frame}</span>
                                            ${t.nodeId ? `<button onclick="locateNode('${t.nodeId}')" style="background:none; border:none; cursor:pointer; font-size:14px; padding:0; color:var(--accent);" title="Locate on Canvas">‚åñ</button>` : ''}
                                            <span>‚è≥ ${t.ageInDays}d old</span>
                                        </div>
                                    </div>
                                    <select onchange="updateTask('${t.commentId}', 'effort', parseInt(this.value))">
                                        <option value="1" ${t.effort == 1 ? 'selected' : ''}>S</option>
                                        <option value="2" ${t.effort == 2 ? 'selected' : ''}>M</option>
                                        <option value="3" ${t.effort == 3 ? 'selected' : ''}>L</option>
                                    </select>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            mainContent.innerHTML = html;
        }

        function matchesFilter(t) {
            if (currentFilter === 'all') return true;
            if (currentFilter === 'unresolved') return !t.resolved;
            if (currentFilter === 'discussion') return t.discussionStatus !== 'pending';
            return true;
        }

        function updateTask(id, key, value) {
            parent.postMessage({ pluginMessage: { type: 'update-task', payload: { id, key, value } } }, '*');
        }

        function locateNode(nodeId) {
            parent.postMessage({ pluginMessage: { type: 'locate-node', payload: nodeId } }, '*');
        }

        function renderError(err) {
            mainContent.innerHTML = `
                <div class="error-state" style="padding: 40px; text-align: center;">
                    <div style="font-size: 32px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                    <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px; color: var(--danger);">Error</div>
                    <div style="font-size: 13px; opacity: 0.7; word-break: break-all;">${err}</div>
                </div>
            `;
        }
    </script>
</body>

</html>