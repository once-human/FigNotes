<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>FigNotes Modern</title>
    <style>
        :root {
            --bg: #FAFAF9;
            --surface: #FFFFFF;
            --accent: #8DA399;
            --accent-soft: #E2E8E4;
            --text-primary: #444442;
            --text-secondary: #71716F;
            --border: #EBEBE9;
            --radius: 12px;
            --transition: all 0.2s ease;
            --danger: #E76F51;
            --success: #A3B18A;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            margin: 0;
            user-select: none;
            overflow-x: hidden;
        }

        .header {
            padding: 16px 20px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .btn-sync {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            transition: var(--transition);
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            opacity: 0.6;
            transition: var(--transition);
        }

        .btn-icon:hover {
            opacity: 1;
        }

        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }

        .content {
            padding: 16px 20px;
        }

        /* Settings Styles */
        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .input-group input {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            outline: none;
            transition: var(--transition);
        }

        .input-group input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }

        .help-text {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: -4px;
        }

        /* Sync Styles */
        .filter-bar {
            padding: 12px 20px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            border-bottom: 1px solid var(--border);
        }

        .chip {
            padding: 6px 14px;
            border-radius: 20px;
            border: 1px solid var(--border);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            background: var(--surface);
            color: var(--text-secondary);
            transition: var(--transition);
        }

        .chip.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
        }

        .card-header {
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-item {
            padding: 14px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        select {
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid var(--border);
            font-size: 11px;
            color: var(--text-secondary);
            outline: none;
            background: var(--bg);
        }

        /* Tabs & Dashboard Styles */
        .nav-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
        }

        .tab {
            flex: 1;
            padding: 12px 0;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: var(--transition);
        }

        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .summary-block {
            padding: 16px 20px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            text-align: center;
        }

        .metric-row {
            padding: 0 16px 16px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .progress-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* Analytics Tab Styles */
        .analytics-panel {
            padding: 20px;
        }

        .user-bar-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .user-label {
            width: 100px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-bar-bg {
            flex: 1;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .user-bar-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .user-count {
            width: 24px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: right;
        }

        .export-group {
            padding: 16px 20px;
            display: flex;
            gap: 12px;
            border-top: 1px solid var(--border);
            background: var(--surface);
        }

        .btn-outline {
            flex: 1;
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            transition: var(--transition);
        }

        .btn-outline:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .health-badge {
            font-size: 11px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .health-Healthy {
            background: #E2F5EC;
            color: #1BC47D;
        }

        .health-At-Risk {
            background: #FFF1E5;
            color: #F2994A;
        }

        .health-Critical {
            background: #FCEAEA;
            color: #EB5757;
        }
    </style>
</head>

<body>
    <div class="header">
        <div
            style="font-weight: 700; font-size: 18px; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px;">
            FigNotes
            <button class="btn-icon" id="settingsToggleBtn" title="Settings">‚öôÔ∏è</button>
        </div>
        <button id="syncBtn" class="btn-sync">Sync</button>
    </div>

    <!-- SETTINGS VIEW -->
    <div id="settingsView" class="view-section content active">
        <div style="margin-bottom: 24px;">
            <h2 style="margin: 0 0 8px 0; font-size: 16px;">Configuration</h2>
            <p style="margin: 0; font-size: 13px; color: var(--text-secondary); line-height: 1.4;">
                Figma requires a Personal Access Token (PAT) and the File URL to securely extract comments.
            </p>
        </div>

        <div class="settings-form">
            <div class="input-group">
                <label for="patInput">Personal Access Token</label>
                <input type="password" id="patInput" placeholder="figd_...">
                <div class="help-text">Generate this in Figma Account Settings > Personal access tokens.</div>
            </div>

            <div class="input-group">
                <label for="urlInput">Figma File URL</label>
                <input type="text" id="urlInput" placeholder="https://www.figma.com/file/...">
                <div class="help-text">Paste the full URL of this exact file.</div>
            </div>

            <button class="btn-sync" id="saveSettingsBtn" style="margin-top: 8px;">Save Configuration</button>
        </div>
    </div>

    <!-- MAIN SYNC VIEW -->
    <div id="mainView" class="view-section">
        <div class="nav-tabs">
            <div class="tab active" onclick="switchTab('flow')">Flow Execution</div>
            <div class="tab" onclick="switchTab('discussion')">Discussion Board</div>
            <div class="tab" onclick="switchTab('analytics')">Analytics</div>
        </div>

        <div id="summary" class="summary-block" style="display:none;"></div>

        <div id="flow-view" class="content">
            <div class="filter-bar">
                <div class="chip active" onclick="setFilter('all')">All</div>
                <div class="chip" onclick="setFilter('unresolved')">Unresolved</div>
                <div class="chip" onclick="setFilter('discussion')">Discussion</div>
            </div>
            <div id="flowContent"></div>
        </div>

        <div id="discussion-view" class="content" style="display:none;">
            <div id="discussionContent"></div>
        </div>

        <div id="analytics-view" class="content" style="display:none;">
            <h3 style="margin-top:0; font-size:14px;">Resolution Analytics</h3>
            <div id="userAnalytics" class="analytics-panel"></div>
        </div>

        <div class="export-group">
            <button class="btn-outline" onclick="exportData('markdown')">Export Markdown</button>
            <button class="btn-outline" onclick="exportData('csv')">Export CSV</button>
        </div>
    </div>

    <script>
        const syncBtn = document.getElementById('syncBtn');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const settingsToggleBtn = document.getElementById('settingsToggleBtn');
        const settingsView = document.getElementById('settingsView');
        const mainView = document.getElementById('mainView');

        const patInput = document.getElementById('patInput');
        const urlInput = document.getElementById('urlInput');
        const flowContent = document.getElementById('flowContent');
        const discContent = document.getElementById('discussionContent');
        const userAnalytics = document.getElementById('userAnalytics');
        const summaryEl = document.getElementById('summary');

        let currentFilter = 'all';
        let latestData = null;
        let config = { pat: '', fileUrl: '' };
        let nativeFileKey = null;

        // --- Navigation ---
        let isSettingsOpen = true; // Defaults open until settings load

        function toggleSettings(forceState) {
            isSettingsOpen = forceState !== undefined ? forceState : !isSettingsOpen;
            if (isSettingsOpen) {
                settingsView.classList.add('active');
                mainView.classList.remove('active');
            } else {
                settingsView.classList.remove('active');
                mainView.classList.add('active');
            }
        }

        settingsToggleBtn.onclick = () => toggleSettings();

        // --- Messages from Code.ts ---
        window.onmessage = (event) => {
            const { type, payload } = event.data.pluginMessage;

            if (!type) return;

            if (type === 'init') {
                if (payload && payload.fileKey) {
                    nativeFileKey = payload.fileKey;
                    document.getElementById('urlInput').placeholder = "Auto-detected by Figma! Leave blank.";
                }
                // Request settings on boot
                parent.postMessage({ pluginMessage: { type: 'get-settings' } }, '*');
            }
            else if (type === 'settings-loaded') {
                config = payload;
                patInput.value = config.pat || '';
                urlInput.value = config.fileUrl || '';

                if (config.pat && (config.fileUrl || nativeFileKey)) {
                    toggleSettings(false);
                    triggerSync();
                } else {
                    toggleSettings(true);
                }
            }
            else if (type === 'sync-complete') {
                latestData = payload;
                renderTasks();
                setSyncingState(false);
            }
            else if (type === 'sync-error') {
                renderError(payload || "Unknown error occurred.");
                setSyncingState(false);
            }
            else if (type === 'export-data') {
                downloadFile(payload.content, `fignotes_export.${payload.format}`);
            }
        };

        // --- Settings Management ---
        saveSettingsBtn.onclick = () => {
            config.pat = patInput.value.trim();
            config.fileUrl = urlInput.value.trim();

            if (!config.pat || (!config.fileUrl && !nativeFileKey)) {
                alert("Both Token and URL are required (unless URL was auto-detected).");
                return;
            }

            parent.postMessage({
                pluginMessage: { type: 'save-settings', payload: config }
            }, '*');

            toggleSettings(false);
            triggerSync();
        };

        // --- Core Sync Logic (REST API + Canvas Merge) ---
        function setSyncingState(isSyncing) {
            syncBtn.disabled = isSyncing;
            syncBtn.innerText = isSyncing ? 'Syncing...' : 'Sync';
        }

        syncBtn.onclick = triggerSync;

        async function triggerSync() {
            if (!config.pat || (!config.fileUrl && !nativeFileKey)) {
                toggleSettings(true);
                return;
            }

            setSyncingState(true);
            flowContent.innerHTML = `<div style="text-align:center; padding: 40px; color: var(--text-secondary);">Fetching comments from Figma API...</div>`;

            let fileKey = nativeFileKey;
            if (!fileKey) {
                // Extract File Key from URL (e.g. https://www.figma.com/file/abc123def/...)
                const match = config.fileUrl.match(/figma\.com\/(?:file|design)\/([a-zA-Z0-9]+)/);
                if (!match) {
                    renderError("Invalid Figma URL format. Could not extract File Key.");
                    setSyncingState(false);
                    return;
                }
                fileKey = match[1];
            }

            try {
                // 1. Fetch Comments via REST API
                const response = await fetch(`https://api.figma.com/v1/files/${fileKey}/comments`, {
                    headers: {
                        'X-Figma-Token': config.pat
                    }
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();

                // 2. Send Raw REST Comments to canvas to resolve nodes/frames and merge with Storage
                parent.postMessage({
                    pluginMessage: { type: 'sync', payload: data.comments }
                }, '*');

            } catch (err) {
                console.error("REST API Error:", err);
                renderError("Failed to fetch comments. Check your Token and URL. Detail: " + err.message);
                setSyncingState(false);
            }
        }

        // --- View Logic ---
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('flow-view').style.display = tab === 'flow' ? 'block' : 'none';
            document.getElementById('discussion-view').style.display = tab === 'discussion' ? 'block' : 'none';
            document.getElementById('analytics-view').style.display = tab === 'analytics' ? 'block' : 'none';
        }

        function setFilter(f) {
            currentFilter = f;
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            if (event) event.target.classList.add('active');
            renderTasks();
        }

        function renderTasks() {
            if (!latestData || !latestData.metrics || latestData.metrics.length === 0) {
                flowContent.innerHTML = `
                    <div style="text-align:center; padding: 80px 40px; color: var(--text-secondary);">
                        <div style="font-size: 32px; margin-bottom: 16px;">üí¨</div>
                        <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">No comments found</div>
                        <div style="font-size: 13px; opacity: 0.7;">Ensure the URL points to this exact file.</div>
                    </div>
                `;
                summaryEl.style.display = 'none';
                return;
            }

            // Summary
            summaryEl.style.display = 'block';
            summaryEl.innerText = latestData.weeklySummary;

            // Flow Execution View
            let html = '';
            latestData.metrics.forEach(flow => {
                const tasks = latestData.tasks.filter(t => t.page === flow.flowName && matchesFilter(t));
                if (tasks.length === 0 && currentFilter !== 'all') return;

                const healthClass = flow.health.replace(' ', '-');
                const progressColor = flow.health === 'Healthy' ? '#1BC47D' : (flow.health === 'At Risk' ? '#F2994A' : '#EB5757');

                html += `
                    <div class="card">
                        <div class="card-header">
                            <div style="flex:1;">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <div style="font-weight: 600; font-size: 15px;">${flow.flowName}</div>
                                    <span class="health-badge health-${healthClass}">${flow.health}</span>
                                </div>
                            </div>
                        </div>
                        <div class="metric-row">
                            <div class="progress-info">
                                <span>Completion</span>
                                <span>${Math.round(flow.weightedCompletion)}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${flow.weightedCompletion}%; background: ${progressColor}"></div>
                            </div>
                        </div>
                        <div class="tasks">
                            ${tasks.map(t => renderTaskItem(t)).join('')}
                        </div>
                    </div>
                `;
            });

            flowContent.innerHTML = html;

            // Discussion View
            const discTasks = latestData.tasks.filter(t => t.discussionStatus !== 'pending' || t.isAvoidance);
            discContent.innerHTML = discTasks.length
                ? discTasks.map(t => `<div class="card" style="margin-bottom:8px;"><div class="tasks">${renderTaskItem(t)}</div></div>`).join('')
                : '<p style="text-align:center; padding: 20px; color: var(--text-secondary);">No active discussions or blocked items.</p>';

            // Analytics View
            if (latestData.allResolvedByUser && latestData.allResolvedByUser.length > 0) {
                const maxCount = Math.max(...latestData.allResolvedByUser.map(u => u.count), 1);
                userAnalytics.innerHTML = latestData.allResolvedByUser.map(u => `
                    <div class="user-bar-row">
                        <span class="user-label" title="${u.user}">${u.user}</span>
                        <div class="user-bar-bg">
                            <div class="user-bar-fill" style="width: ${(u.count / maxCount) * 100}%"></div>
                        </div>
                        <span class="user-count">${u.count}</span>
                    </div>
                `).join('');
            } else {
                userAnalytics.innerHTML = '<p style="color: var(--text-secondary);">No resolutions recorded yet.</p>';
            }
        }

        function renderTaskItem(t) {
            return `
                <div class="task-item">
                    <div style="flex: 1;">
                        <div style="font-weight: 500; font-size: 13px; line-height: 1.4; ${t.resolved ? 'text-decoration: line-through; opacity: 0.5;' : ''}">${t.message}</div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 6px; display: flex; gap: 8px; align-items: center;">
                            <span>üè† ${t.frame}</span>
                            ${t.nodeId ? `<button onclick="locateNode('${t.nodeId}')" style="background:none; border:none; cursor:pointer; font-size:14px; padding:0; color:var(--accent);" title="Locate on Canvas">‚åñ</button>` : ''}
                            <span style="${t.ageInDays > 5 ? 'color: var(--danger); font-weight:600;' : ''}">‚è≥ ${t.ageInDays}d old</span>
                            ${t.isAvoidance ? '<span style="color:var(--danger); font-weight:600;">(High Avoidance)</span>' : ''}
                        </div>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:4px;">
                        <select onchange="updateTask('${t.commentId}', 'effort', parseInt(this.value))">
                            <option value="1" ${t.effort == 1 ? 'selected' : ''}>S Effort</option>
                            <option value="2" ${t.effort == 2 ? 'selected' : ''}>M Effort</option>
                            <option value="3" ${t.effort == 3 ? 'selected' : ''}>L Effort</option>
                        </select>
                        <select onchange="updateTask('${t.commentId}', 'discussionStatus', this.value)">
                            <option value="pending" ${t.discussionStatus == 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="discussion" ${t.discussionStatus == 'discussion' ? 'selected' : ''}>Discuss</option>
                            <option value="blocked" ${t.discussionStatus == 'blocked' ? 'selected' : ''}>Blocked</option>
                        </select>
                    </div>
                </div>
            `;
        }

        function matchesFilter(t) {
            if (currentFilter === 'all') return true;
            if (currentFilter === 'unresolved') return !t.resolved;
            if (currentFilter === 'discussion') return t.discussionStatus !== 'pending';
            return true;
        }

        function updateTask(id, key, value) {
            parent.postMessage({ pluginMessage: { type: 'update-task', payload: { id, key, value } } }, '*');
        }

        function locateNode(nodeId) {
            parent.postMessage({ pluginMessage: { type: 'locate-node', payload: nodeId } }, '*');
        }

        function renderError(err) {
            flowContent.innerHTML = `
                <div class="error-state" style="padding: 40px; text-align: center;">
                    <div style="font-size: 32px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                    <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px; color: var(--danger);">Error</div>
                    <div style="font-size: 13px; opacity: 0.7; word-break: break-all;">${err}</div>
                </div>
            `;
        }

        function exportData(format) {
            parent.postMessage({ pluginMessage: { type: 'export', payload: { format, data: latestData } } }, '*');
        }

        function downloadFile(content, fileName) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
        }
    </script>
</body>

</html>